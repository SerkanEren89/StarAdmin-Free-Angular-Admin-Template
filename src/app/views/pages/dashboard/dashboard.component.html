<div class="row title-container">
  <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 left">
    <span class="input-group-text text-primary title" *ngIf="competitorHotel == null && currentUser != null">
      {{currentUser.hotelName}}
    </span>
    <span class="input-group-text text-primary title" *ngIf="competitorHotel != null">
      {{competitorHotel.name}}</span>
  </div>

  <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 filter-button">
    <button type="button" class="btn btn-primary" (click)="openCompetitorModal(contentCompetition)">
      Select Competitor
    </button>
  </div>
</div>

<div class="row">
  <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 grid-margin stretch-card rating-card" *ngFor="let commentCountRating of commentCountRatings">
    <div class="card card-statistics" (click)="goToDetail(commentCountRating.source)">
      <div class="card-body pointer">
        <div class="clearfix">
          <div class="float-left">
            <app-channel-icon [source]="commentCountRating.source.toLowerCase()"></app-channel-icon>
          </div>
          <div class="float-right">
            <p class="mb-0 text-right">{{commentCountRating.source}}</p>
            <div class="fluid-container">
              <h3 class="font-weight-medium text-right mb-0">{{commentCountRating.rating}}</h3>
              <p class="text-right mb-0">{{commentCountRating.commentCount}} Reviews</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row title-container" *ngIf="categoryGroupList != null && categoryGroupList.length > 0">
  <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 left">
    <span class="input-group-text text-primary title">
      <img class="mdi mdi-cube icon-lg category-icon side-icon" src="assets/svg/category.svg">
      Popular Categories
    </span>
  </div>
</div>
<div class="row">
  <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 grid-margin stretch-card rating-card"
       (click)="goToCategoryDetail(categoryGroup.category.name)"
       *ngFor='let categoryGroup of categoryGroupList | slice:0:4'>
    <div class="card card-statistics">
      <div class="card-body pointer">
        <div class="clearfix">
          <div class="float-left">
            <app-category-icon [category]="categoryGroup.category.name" [fontSize] = "30" [maxWidth]="45"></app-category-icon>
          </div>
          <div class="float-right">
            <p class="mb-0 text-right">{{categoryGroup.category.name}}</p>
            <div class="fluid-container">
              <h3 class="font-weight-medium text-right mb-0">%{{categoryGroup.score}}</h3>
              <p class="text-right mb-0">{{categoryGroup.totalMention}} Reviews</p>
              <p class="text-right mb-0">
                <span class="text-danger">
                {{categoryGroup.negativeCount}}
                  <i class="fa fa-angry"></i>
                </span>
                /
                <span class="text-warning">
                {{categoryGroup.neutralCount}}
                  <i class="fa fa-meh"></i>
                </span>
                /
                <span class="text-success">
                {{categoryGroup.positiveCount}}
                  <i class="fa fa-smile"></i>
                </span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row" *ngIf="lineChartData.length > 0">
  <div class="col-lg-6 grid-margin stretch-card">
    <!--weather card-->
    <div class="card">
      <div class="card-body">
        <h2 class="card-title text-primary mb-5">Rating</h2>
        <app-line-chart [height]="400" [lineChartData]="lineChartData" [lineChartLabels]="lineChartLabels"></app-line-chart>
      </div>
    </div>
    <!--weather card ends-->
  </div>
  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <h2 class="card-title text-primary mb-5">Review by channel</h2>
        <app-pie-chart [pieChartData]="pieChartData" [pieChartLabels]="pieChartLabels"></app-pie-chart>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 grid-margin stretch-card rating-card" *ngIf="responseRateModel != null">
    <div class="card card-statistics" >
      <div class="card-body pointer">
        <div class="clearfix">
          <div class="float-left">
            <img class="mdi mdi-cube icon-lg category-icon" src="assets/svg/answered.svg">
          </div>
          <div class="float-right">
            <p class="mb-0 text-right">{{responseRateModel.answeredCount}} / {{responseRateModel.notAnsweredCount + responseRateModel.answeredCount}}</p>
            <div class="fluid-container">
              <h3 class="font-weight-medium text-right mb-0 text-primary" *ngIf="responseRateModel.responseRate >= 90">{{responseRateModel.responseRate}}%</h3>
              <h3 class="font-weight-medium text-right mb-0 text-warning" *ngIf="responseRateModel.responseRate > 40 && responseRateModel.responseRate < 90">{{responseRateModel.responseRate}}%</h3>
              <h3 class="font-weight-medium text-right mb-0 text-danger" *ngIf="responseRateModel.responseRate <= 40">{{responseRateModel.responseRate}}%</h3>
              <p class="text-right mb-0">Response rate</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 grid-margin stretch-card rating-card" *ngFor="let commentCountPeriod of commentCountPeriods | slice:1:4">
    <div class="card card-statistics" >
      <div class="card-body pointer">
        <div class="clearfix">
          <div class="float-left">
            <i class="fa fa-clock category-icon"></i>
          </div>
          <div class="float-right">
            <p class="mb-0 text-right">{{commentCountPeriod.label}}</p>
            <div class="fluid-container">
              <h3 class="font-weight-medium text-right mb-0">{{commentCountPeriod.count}}</h3>
              <p class="text-right mb-0">Reviews</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row" *ngIf="commentList.length > 0">
  <div class="col-lg-12 grid-margin">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Last 10 Customer Reviews</h4>
        <div class="table-responsive">
          <table class="table table-bordered" #commentTable>
            <thead>
            <tr>
              <th style="width: 10%" *ngIf="competitorHotel == null">
                Highlight
              </th>
              <th style="width: 10%">
                Reply
              </th>
              <th style="width: 40%">
                Review
              </th>
              <th style="width: 10%">
                Channel
              </th>
              <th style="width: 15%">
                Review Date
              </th>
              <th style="width: 15%">
                Rating
              </th>
              <th style="width: 15%">
                Actions
              </th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let comment of commentList">
              <td class="text star-container" *ngIf="competitorHotel == null">
                <a *ngIf="!comment.starred" (click)="markAsStarred(comment)"><i class="far fa-star star pointer" ></i></a>
                <a *ngIf="comment.starred" (click)="!markAsStarred(comment)"><i class="fa fa-star star pointer" ></i></a>
              </td>
              <td class="text star-container">
                <img class="mdi mdi-cube icon-lg answered-icon" src="assets/svg/answered.svg"
                     *ngIf="comment.answer != null">
                <span tooltip="Reply customer review">
                  <a (click)="openReplyModal(reply)" *ngIf="competitorHotel == null && comment.answer == null && comment.content != noReviewText"><i class="fa fa-reply action-button text-primary"></i></a>
                </span>
              </td>
              <td class="text comment"
                  (click)="openDetailPopup(comment, contentReviewDetail)"
                  *ngIf="comment.content != null && comment.content.length <= 100">
                <span *ngIf="!comment.content.includes(noReviewText)">
                  {{comment.content}}
                </span>
                <i *ngIf="comment.content.includes(noReviewText)">
                  {{comment.content}}
                </i>
              </td>
              <td class="text comment"
                  (click)="openDetailPopup(comment, contentReviewDetail)"
                  *ngIf="comment.content != null && comment.content.length > 100">
                <span *ngIf="!comment.content.includes(noReviewText)">
                  {{comment.content | slice:0:100}}...
                </span>
                <i *ngIf="comment.content.includes(noReviewText)">
                  {{comment.content}}
                </i>
              </td>
              <td class="text comment"
                  (click)="openDetailPopup(comment, contentReviewDetail)"
                  *ngIf="comment.content == null">
              </td>
              <td>
                <div>
                  <app-channel-icon class="icon" [source]="comment.source.toLowerCase()"></app-channel-icon>
                </div>
              </td>
              <td>
                {{comment.commentDate  | date:'dd/MM/yyyy'}}
              </td>
              <td class="text-danger"
                  [ngClass]="{'text-danger': comment.rating < 6, 'text-warning':(comment.rating >= 6 && comment.rating < 8), 'text-success':comment.rating >= 8 }"> {{comment.rating}} / 10
                <i class="mdi mdi-arrow-down" *ngIf="comment.rating < 6"></i>
                <i class="mdi mdi-arrow-up" *ngIf="comment.rating >= 6"></i>
              </td>
              <td class="text-primary">
                <span tooltip="Assign Task">
                  <a (click)="openTaskModal(comment, contentTask)" *ngIf="competitorHotel == null"><i class="fa fa-tasks action-button"></i></a>
                </span>
                <span tooltip="Go to Source">
                  <a target="_blank" *ngIf="comment.url != null" href={{comment.url}}><i class="fa fa-link action-button"></i></a>
                </span>
              </td>
            </tr>
            </tbody>
          </table>
          <div class="see-all-container">
            <a class="see-all text-primary" routerLink="/inbox">See all reviews</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #contentTask let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title">Assign new task</h4>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div class="summary-container">
      <div class="summary">
        <div class="detail-container">
          <app-channel-icon [source]="selectedComment.source.toLowerCase()"></app-channel-icon>
          <p class="written" >Written By: {{selectedComment.author}}</p>
          <p class="written">{{selectedComment.commentDate  | date:'dd/MM/yyyy'}}</p>
        </div>
        <p class="title content-comment">{{selectedComment.content}}</p>
      </div>
    </div>
    <form class="assignee-form">
      <div class="form-group">
        <label>Assignee</label>
        <div class="input-group task-input">
          <input id="assignee" type="text" class="form-control" name="assignee"
                 [resultFormatter]="resultFormatter"
                 [inputFormatter]="inputFormatter"
                 [(ngModel)]="task.employee" [ngbTypeahead]="search"
                 (focus)="focus$.next($event.target.value)"/>
        </div>
      </div>
      <div *ngIf="showAddEmployeeFlow" class="warning-body">
        <div class="warning-container ">
          <p>The employee does not exist</p>
          <p>
            <a href="/employee" (click)="addNewEmployee()">Click to add new employee</a>
          </p>
        </div>
      </div>
      <div class="form-group">
        <label>Description</label>
        <div class="input-group">
          <textarea id="description" type="text" class="form-control"
                    name="description" [(ngModel)]="task.description" rows="3"></textarea>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="assignTask(task)">Assign</button>
  </div>
</ng-template>


<ng-template #contentReviewDetail let-modalReview>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-comment-detail">Review Detail</h4>
    <button type="button" class="close" aria-label="Close" (click)="modalReview.dismiss('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div class="summary-container">
      <div class="summary">
        <div class="detail-container">
          <app-channel-icon [source]="selectedComment.source.toLowerCase()"></app-channel-icon>
          <p class="written" >Written By: {{selectedComment.author}}</p>
          <p class="written">{{selectedComment.commentDate  | date:'dd/MM/yyyy'}}</p>
          <a target="_blank" class="share-icon" *ngIf="!isMobile" href="https://web.whatsapp.com/send?text={{selectedComment.content}}" data-text="Take a look at this comment:">
            <i class="fa fa-share"></i>
            Share
          </a>
          <a target="_blank" class="share-icon" *ngIf="isMobile" href="whatsapp://send?text={{selectedComment.content}}" data-text="Take a look at this comment:">
            <i class="fa fa-share action-button"></i>
          </a>
        </div>
        <p *ngIf="!selectedComment.content.includes(noReviewText)" class="content-comment">{{selectedComment.content}}</p>
        <p *ngIf="selectedComment.content.includes(noReviewText)" class="content-comment"><i>{{selectedComment.content}}</i></p>
        <div class="content-container" *ngIf="selectedComment.translatedText != null">
          <p class="text-danger content-title">Translated Review: </p>
          <p class="content-answer">{{selectedComment.translatedText}}</p>
        </div>
        <div class="content-container" *ngIf="selectedComment.answer != null">
          <p class="text-danger content-title">Hotel's response:</p>
          <p class="content-answer">{{selectedComment.answer}}</p>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <div class="template-demo">
      <button type="button" class="btn btn-primary" *ngIf="selectedComment.translatedText == null" (click)="translate(selectedComment)"><i class="fa fa-language"></i>Translate</button>
      <button type="button" class="btn btn-primary" *ngIf="!selectedComment.starred && competitorHotel == null" (click)="markAsStarred(selectedComment)"><i class="mdi mdi-star"></i>Mark as Important</button>
      <button type="button" class="btn btn-primary" *ngIf="selectedComment.starred && competitorHotel == null" (click)="markAsStarred(selectedComment)"><i class="mdi mdi-star"></i>Mark as Unimportant</button>
    </div>
  </div>
</ng-template>

<ng-template #contentCompetition let-modalCompetiton>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-competition">Select Competitor</h4>
    <button type="button" class="close" aria-label="Close" (click)="modalCompetiton.dismiss('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div class="summary-container" *ngIf="competitionList.length > 1">
      <div class="summary">
        <div *ngFor="let competition of competitionList">
          <label for="enum_answer_{{competition.name}}">
            <input id="enum_answer_{{competition.name}}" [value]='competition' type="radio" name="enums" [(ngModel)]="selectedCompetitor">
            <b *ngIf="competition.selected" class="competitor-item">{{competition.name}}</b>
            <span *ngIf="!competition.selected" class="competitor-item">{{competition.name}}</span>
          </label>
        </div>
      </div>
    </div>

    <div class="warning-body" *ngIf="competitionList.length == 1">
      <div class="warning-container">
        <i class="fa fa-exclamation-triangle warning text-warning"></i>
        <p>
          Please contact us to give your competition list.
        </p>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <div class="template-demo">
      <button type="button" class="btn btn-primary" (click)="changeHotel()" *ngIf="competitionList.length > 0">
        Change Hotel
      </button>
    </div>
  </div>
</ng-template>

<ng-template #reply let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-answer-title">Reply Customer Review</h4>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <form class="assignee-form" *ngIf="!newTemplateFlow">
      <div class="form-group">
        <label>Saved Templates</label>
        <div ngbDropdown container="body" *ngIf="templates.length > 0" class="template-container">
          <button class="btn btn-outline-primary btn-sm " ngbDropdownToggle>{{selectedTemplate.title}}</button>
          <div ngbDropdownMenu>
            <button ngbDropdownItem *ngFor="let template of templates" (click)="selectTemplate(template)">{{template.title}}</button>
          </div>
        </div>
      </div>
    </form>
    <form class="reply-form" *ngIf="newTemplateFlow">
      <div class="form-group answer">
        <label>Title</label>
        <div class="input-group">
          <input id="title" type="text" class="form-control" name="title"
                 [(ngModel)]="newTemplate.title"/>
        </div>
      </div>
    </form>
    <div class="form-group answer">
      <label>Your Response</label>
      <div class="input-group">
          <textarea type="text" name="content" class="form-control" #inputTarget
                    placeholder="Dear Guest,&#10;&#10;Your response will be here..." rows="12" [(ngModel)]="selectedTemplate.content"></textarea>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" *ngIf="!newTemplateFlow" (click)="toNewTemplate()">Save as Template</button>
    <button type="button" class="btn btn-primary"
            tooltip="You will be redirected to the {{this.selectedItem.source}} where you can paste your response" placement="right"
            (cbOnSuccess)="copyAndGo($event)" [ngxClipboard]="inputTarget">
      Copy & Go
    </button>
    <button type="button" class="btn btn-danger" *ngIf="newTemplateFlow" (click)="cancelTemplateFlow()">Cancel</button>
    <button type="button" class="btn btn-primary" *ngIf="newTemplateFlow" (click)="saveNewTemplate()">Save new Template</button>
  </div>
</ng-template>
